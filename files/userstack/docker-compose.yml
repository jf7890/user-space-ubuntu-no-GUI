services:
  # PostgreSQL Database
  postgres-nginx-love:
    image: postgres:15-alpine
    container_name: nginx-love-postgres
    hostname: postgres-nginx-love
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-nginx_waf}
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    volumes:
      - postgres_nginx_love_data:/var/lib/postgresql/data
      - ./nginx-love/docker/database.sql:/docker-entrypoint-initdb.d/01-database.sql:ro
      - ./nginx-love/apps/api/prisma/migrations:/docker-entrypoint-initdb.d/migrations
    networks:
      - capstone-dmz-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres} -d ${DB_NAME:-nginx_waf}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Backend API Service
  backend:
    image: vouu/nginx-waf-backend:ubuntu2404
    restart: unless-stopped
    container_name: nginx-love-backend
    # network_mode: host
    hostname: backend
    ports:
      - "${API_PORT:-3001}:3001"
      - "80:80"
      - "443:443"
    #   # add more port for NLB
    environment:
      # Database Configuration
      DATABASE_URL: "postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@postgres-nginx-love:5432/${DB_NAME:-nginx_waf}?schema=public"

      # Server Configuration
      PORT: ${API_PORT:-3001}
      NODE_ENV: ${NODE_ENV:-production}

      # JWT Configuration
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET:-07fda7ee-9613-48c3-b8ad-54d56a23445c}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-6dc381ae-88f6-428d-99a7-c1f24a7685ab}
      JWT_ACCESS_EXPIRES_IN: ${JWT_ACCESS_EXPIRES_IN:-15m}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-7d}

      # CORS Configuration
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:8080,http://localhost:5173}

      # Security
      BCRYPT_ROUNDS: ${BCRYPT_ROUNDS:-10}

      # Session
      SESSION_SECRET: ${SESSION_SECRET:-ba715a25-ff58-4f06-bb48-4669a27e446f}

      # 2FA
      TWO_FACTOR_APP_NAME: ${TWO_FACTOR_APP_NAME:-Nginx WAF Admin}

      # SSL Configuration
      SSL_DIR: ${SSL_DIR:-/etc/nginx/ssl}
      ACME_DIR: ${ACME_DIR:-/var/www/html/.well-known/acme-challenge}

      # SMTP Configuration
      SMTP_HOST: ${SMTP_HOST:-smtp.example.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-user@example.com}
      SMTP_PASS: ${SMTP_PASS:-change-this-to-random-password}
    volumes:
      - backup:/var/backups
      - nginx_modules:/usr/lib/nginx
      - nginx_conf:/etc/nginx
      - ./logs/nginx:/var/log/nginx
      - acme_challenge:/var/www/html/.well-known/acme-challenge
      - ./nginx-love/config/nginx.conf:/etc/nginx/nginx.conf:ro

      - ./config/modsecurity.conf:/etc/nginx/modsec/modsecurity.conf:ro
      - ./logs/modsecurity:/var/log/modsecurity
      - ./scripts/add-log-dir.sh:/add-log-dir.sh:ro
    entrypoint: /bin/sh -c "sh /add-log-dir.sh && exec /start.sh"
    depends_on:
      postgres-nginx-love:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - capstone-dmz-network
  # Frontend Web Service
  frontend:
    build:
      context: nginx-love
      dockerfile: docker/Dockerfile.frontend
      args:
        - NODE_ENV=${NODE_ENV:-production}
        - VITE_API_URL=${VITE_API_URL:-http://localhost:3001/api}
    container_name: nginx-love-frontend
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-8080}:8080"
    networks:
      - capstone-dmz-network
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  # Bootstrap helper container: waits for Postgres + API health, then runs bootstrap-nginx_love.sh once
  # (state stored in nginx_love_bootstrap_state so it won't rerun on restart; container removes itself afterwards)
  nginx-love-bootstrap:
    image: docker:27-cli
    container_name: nginx-love-bootstrap
    restart: on-failure:20
    networks:
      - capstone-dmz-network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./scripts/bootstrap-nginx_love.sh:/bootstrap-nginx_love.sh:ro
      - nginx_love_bootstrap_state:/state
    environment:
      API_BASE: "http://nginx-love-backend:3001/api"
      ADMIN_USERNAME: admin
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      NEW_ADMIN_PASSWORD: ${NEW_ADMIN_PASSWORD}
      TOTP_CODE: "${TOTP_CODE:-}"
      PROXY_CONTAINER: "nginx-love-backend"
      JUICESHOP_CONTAINER: "juice-shop"
      DVWA_CONTAINER: "dvwa"
      AUTO_CONNECT_NETWORK: "true"
    depends_on:
      postgres-nginx-love:
        condition: service_healthy
      backend:
        condition: service_healthy
      dvwa:
        condition: service_started
      juiceshop:
        condition: service_started
    entrypoint: ["/bin/sh"]
    command:
      - -c
      - |
          set -eu
          SELF_NAME="nginx-love-bootstrap"
          STATE_FILE="/state/.nginx_love_bootstrapped"

          # If already bootstrapped, stay idle (so the container remains Up)
          if [ -f "$$STATE_FILE" ]; then
            echo "[bootstrap] already bootstrapped -> removing self"
            docker rm -f "$$SELF_NAME" >/dev/null 2>&1 || true
            exit 0
          fi

          apk add --no-cache bash curl jq >/dev/null

          # Wait until Postgres is truly "healthy" (prevents backend 500 errors when Prisma is not connected yet)
          echo "[bootstrap] waiting postgres healthy..."
          while [ "$(docker inspect -f '{{.State.Health.Status}}' nginx-love-postgres 2>/dev/null || echo starting)" != "healthy" ]; do
            sleep 2
          done

          # Wait for API health endpoint
          echo "[bootstrap] waiting for API health: $$API_BASE/health"
          while ! curl -fsS "$$API_BASE/health" >/dev/null 2>&1; do
            sleep 2
          done


          # Windows or CRLF -> strip \r
          cp /bootstrap-nginx_love.sh /tmp/bootstrap-nginx-love.sh
          sed -i 's/\r$//' /tmp/bootstrap-nginx-love.sh

          echo "[bootstrap] running bootstrap once..."
          bash /tmp/bootstrap-nginx-love.sh

          touch "$$STATE_FILE"
          echo "[bootstrap] done -> removing self"
          docker rm -f "$$SELF_NAME" >/dev/null 2>&1 || true
          exit 0
  dvwa:
    image: vulnerables/web-dvwa
    container_name: dvwa
    restart: unless-stopped
    environment:
      - TZ=${TZ:-Asia/Ho_Chi_Minh}
    volumes:
      - ./config/mysql-logging.cnf:/mysql-logging.cnf:ro
      - ./logs/mysql:/var/log/mysql
      - ./logs/apache:/var/log/apache2
      - ./fim/dvwa_upload:/var/www/html/hackable/uploads
    networks:
      - capstone-dmz-network

  postgres:
    image: postgres:15
    container_name: postgres-juiceshop
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${JUICE_SHOP_POSTGRES_DB:-juiceshop}
      - POSTGRES_USER=${JUICE_SHOP_POSTGRES_USER:-juiceshop}
      - POSTGRES_PASSWORD=${JUICE_SHOP_POSTGRES_PASSWORD:-juiceshop123}
      - TZ=${TZ:-Asia/Ho_Chi_Minh}
    volumes:
      - ./config/postgres-logging.conf:/etc/postgresql/postgresql.conf:ro
      - ./logs/postgres:/var/log/postgresql
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-postgres.sh:/docker-entrypoint-initdb.d/init-postgres.sh:ro

    # Use custom entrypoint to fix log directory permissions before starting postgres
    entrypoint: ["/bin/bash", "/docker-entrypoint-initdb.d/init-postgres.sh"]
    networks:
      - capstone-dmz-network

  juiceshop:
    image: hotailienvykha/juiceshop-fork:latest
    container_name: juice-shop
    restart: unless-stopped
    environment:
      - TZ=${TZ:-Asia/Ho_Chi_Minh}
      - NODE_ENV=${NODE_ENV:-development}
      # Database configuration - can be changed via environment
      - DB_DIALECT=${DB_DIALECT:-postgres}
      - DB_HOST=${JUICE_SHOP_DB_HOST:-postgres}
      - DB_PORT=${JUICE_SHOP_DB_PORT:-5432}
      - DB_NAME=${JUICE_SHOP_DB_NAME:-juiceshop}
      - DB_USER=${JUICE_SHOP_DB_USER:-juiceshop}
      - DB_PASSWORD=${JUICE_SHOP_DB_PASSWORD:-juiceshop123}
    depends_on:
      - postgres
    volumes:
      - ./logs/juiceshop:/var/log/juiceshop
      - ./logs/juiceshop:/juice-shop/logs/access.log.*
      - ./fim/juiceshop_uploads:/juice-shop/uploads
    networks:
      - capstone-dmz-network

volumes:
  postgres_data:
  postgres_nginx_love_data:
    driver: local
  backup:
    driver: local
  nginx_conf:
    driver: local
  acme_challenge:
    driver: local
  nginx_modules:
    driver: local  
  nginx_love_bootstrap_state:
    driver: local

networks:
  capstone-dmz-network: {}
